<odoo>
    <data>
        <report id="l10n_mx_cfdi_document_report"
                model="l10n_mx.cfdi_document"
                string="Documento CFDI"
                report_type="qweb-pdf"
                name="l10n_mx_cfdi_manager.l10n_mx_cfdi_document"
                file="l10n_mx_cfdi_manager.l10n_mx_cfdi_document_report"
                attachment_use="True"
                print_report_name="(object.name)"
                paperformat="base.paperformat_us" />
        
        <template id="l10n_mx_cfdi_document">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <t t-call="web.external_layout">
                        <div class="page">
                            <h2><span>UUID: </span><span t-field="doc.name"/></h2>
    
                            <div class="row mt-4 mb-4" style="font-size:12px"> 
                                <div class="col-auto col-4">
                                    <span><strong>Emisor: </strong><span t-esc="doc.emisor"/><br/></span>
                                    <span><strong>RFC Emisor: </strong><span t-esc="doc.rfc_emisor"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('LugarExpedicion')"><strong>Lugar de expedición: </strong><span t-esc="doc.get_cfdi_data('LugarExpedicion')"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('Fecha')"><strong>Fecha: </strong><span t-esc="doc.get_cfdi_data('Fecha')"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('TipoDeComprobante')"><strong>Tipo de documento: </strong><span t-esc="doc.get_cfdi_data('TipoDeComprobante')"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('Version')"><strong>Versión: </strong><span t-esc="doc.get_cfdi_data('Version')"/><br/></span>
                                    <span t-if="doc.move_id"><strong>Asiento contable: </strong><span t-esc="doc.move_id.display_name"/><br/></span>
                                </div>
                                <div class="col-auto col-4">
                                    <span t-if="doc.get_cfdi_data(' SubTotal')"><strong>Subtotal: </strong><span t-esc="float(doc.get_cfdi_data(' SubTotal'))" t-options='{"widget": "float", "precision": 2}'/><br/></span>
                                    <span t-if="doc.get_cfdi_data(' Total')"><strong>Total: </strong><span t-esc="float(doc.get_cfdi_data(' Total'))" t-options='{"widget": "float", "precision": 2}'/><br/></span>
                                    <span t-if="doc.get_cfdi_data('Moneda')"><strong>Moneda: </strong><span t-esc="doc.get_cfdi_data('Moneda')"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('TipoCambio')"><strong>Tipo de cambio: </strong><span t-esc="doc.get_cfdi_data('TipoCambio')"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('CondicionesDePago')"><strong>Condiciones de Pago: </strong><span t-esc="doc.get_cfdi_data('CondicionesDePago')"/><br/></span>
                                </div>
                                <div class="col-auto col-4">
                                    <span t-if="doc.get_cfdi_data('Serie')"><strong>Serie: </strong><span t-esc="doc.get_cfdi_data('Serie')"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('Folio')"><strong>Folio: </strong><span t-esc="doc.get_cfdi_data('Folio')"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('MetodoPago')"><strong>Método de pago: </strong><span t-esc="doc.get_cfdi_data('MetodoPago')"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('FormaPago')"><strong>Forma de pago: </strong><span t-esc="doc.get_cfdi_data('FormaPago')"/><br/></span>
                                    <span t-if="doc.get_cfdi_data('Exportacion')"><strong>Exportación: </strong><span t-esc="doc.get_cfdi_data('Exportacion')"/><br/></span>
                                    <span t-if="doc.cfdi_state"><strong>Estado: </strong><span t-esc="doc.cfdi_state"/><br/></span>
                                </div>
                            </div>
                            
                            <table class="table table-sm o_main_table table-borderless" style="font-size:12px">
                                <thead>
                                    <tr>
                                        <th class="text-start"><span>Descripción</span></th>
                                        <th class="text-start"><span>Clave</span></th>
                                        <th class="text-start"><span>No. Identificación</span></th>
                                        <th class="text-start"><span>ObjetoImp</span></th>
                                        <th class="text-end"><span>Cantidad</span></th>
                                        <th class="text-start"><span>Clave Unidad</span></th>
                                        <th class="text-start"><span>Unidad</span></th>
                                        <th class="text-end"><span>ValorUnitario</span></th>
                                        <th class="text-end"><span>Importe</span></th>
                                    </tr>
                                </thead>
                                <tbody class="invoice_tbody">
                                    <t t-set="sum_importe" t-value="0"/>
                                    <t t-foreach="doc.get_cfdi_conceptos_data()" t-as="line">
                                        <tr>
                                            <td class="text-start"><span t-esc="line['Descripcion']"/></td>
                                            <td class="text-start"><span t-esc="line['ClaveProdServ']"/></td>
                                            <td class="text-start"><span t-esc="line['NoIdentificacion']"/></td>
                                            <td class="text-start"><span t-esc="line['ObjetoImp']"/></td>
                                            <td class="text-end"><span t-esc="line['Cantidad']"/></td>
                                            <td class="text-start"><span t-esc="line['ClaveUnidad']"/></td>
                                            <td class="text-start"><span t-esc="line['Unidad']"/></td>
                                            <td class="text-end"><span t-esc="line['ValorUnitario']"/></td>
                                            <td class="text-end" t-if="line['Importe'] != ''">
                                                <span t-esc="float(line['Importe'])" t-options='{"widget": "float", "precision": 2}'/>
                                                <t t-set="sum_importe" t-value="sum_importe+float(line['Importe'])"/>
                                            </td>
                                            <td class="text-end" t-if="line['Importe'] == ''">
                                                0.00
                                                <t t-set="sum_importe" t-value="sum_importe+0"/>
                                            </td>
                                        </tr>
                                    </t>
                                    <tr>
                                        <td class="text-start"></td>
                                        <td class="text-start"></td>
                                        <td class="text-start"></td>
                                        <td class="text-start"></td>
                                        <td class="text-end"></td>
                                        <td class="text-start"></td>
                                        <td class="text-start"></td>
                                        <td class="text-end"></td>
                                        <td class="text-end"><strong><span t-esc="float(sum_importe)" t-options='{"widget": "float", "precision": 2}'/></strong></td>
                                    </tr>
                                </tbody>
                            </table>

                            <br/>
                            
                            <table class="table table-sm o_main_table table-borderless" style="font-size:12px">
                                <thead>
                                    <tr>
                                        <th class="text-start"><span>Descripción</span></th>
                                        <th class="text-start"><span>Impuesto</span></th>
                                        <th class="text-start"><span>Tipo de Factor</span></th>
                                        <th class="text-start"><span>Tasa o Cuota</span></th>
                                        <th class="text-end"><span>Base</span></th>
                                        <th class="text-end"><span>Importe</span></th>
                                    </tr>
                                </thead>
                                <tbody class="invoice_tbody">
                                    <t t-set="sum_base" t-value="0"/>
                                    <t t-set="sum_importe" t-value="0"/>
                                    <t t-foreach="doc.get_cfdi_conceptos_data()" t-as="line">
                                        <t t-foreach="line['Impuestos']" t-as="impuesto">
                                            <tr>
                                                <td class="text-start"><span t-esc="line['Descripcion']"/></td>
                                                <td class="text-start"><span t-esc="impuesto['Impuesto']"/></td>
                                                <td class="text-start"><span t-esc="impuesto['TipoFactor']"/></td>
                                                <td class="text-start"><span t-esc="impuesto['TasaOCuota']"/></td>
                                                <td class="text-end"><span t-esc="float(impuesto['Base'])" t-options='{"widget": "float", "precision": 2}'/></td>
                                                <td class="text-end"><span t-esc="float(impuesto['Importe'])" t-options='{"widget": "float", "precision": 2}'/></td>
                                            </tr>
                                            <t t-set="sum_base" t-value="sum_importe+float(impuesto['Base'])"/>
                                            <t t-set="sum_importe" t-value="sum_importe+float(impuesto['Importe'])"/>
                                        </t>
                                    </t>
                                    <tr>
                                        <td class="text-start"></td>
                                        <td class="text-start"></td>
                                        <td class="text-start"></td>
                                        <td class="text-start"></td>
                                        <td class="text-end"><strong><span t-esc="float(sum_base)" t-options='{"widget": "float", "precision": 2}'/></strong></td>
                                        <td class="text-end"><strong><span t-esc="float(sum_importe)" t-options='{"widget": "float", "precision": 2}'/></strong></td>
                                    </tr>
                                </tbody>
                            </table>

                            <br/>
                            
                            <table class="table table-sm o_main_table table-borderless" style="font-size:12px">
                                <thead>
                                    <tr>
                                        <th class="text-start"><span>Impuesto</span></th>
                                        <th class="text-start"><span>Tipo de Factor</span></th>
                                        <th class="text-start"><span>Tasa o Cuota</span></th>
                                        <th class="text-end"><span>Base</span></th>
                                        <th class="text-end"><span>Importe</span></th>
                                    </tr>
                                </thead>
                                <tbody class="invoice_tbody">
                                    <t t-set="sum_base" t-value="0"/>
                                    <t t-set="sum_importe" t-value="0"/>
                                    <t t-foreach="doc.get_cfdi_impuestos_data()" t-as="impuesto">
                                        <tr>
                                            <td class="text-start"><span t-esc="impuesto['Impuesto']"/></td>
                                            <td class="text-start"><span t-esc="impuesto['TipoFactor']"/></td>
                                            <td class="text-start"><span t-esc="impuesto['TasaOCuota']"/></td>
                                            <td class="text-end"><span t-esc="float(impuesto['Base'])" t-options='{"widget": "float", "precision": 2}'/></td>
                                            <td class="text-end"><span t-esc="float(impuesto['Importe'])" t-options='{"widget": "float", "precision": 2}'/></td>
                                        </tr>
                                        <t t-set="sum_base" t-value="sum_importe+float(impuesto['Base'])"/>
                                        <t t-set="sum_importe" t-value="sum_importe+float(impuesto['Importe'])"/>
                                    </t>
                                    <tr>
                                        <td class="text-start"></td>
                                        <td class="text-start"></td>
                                        <td class="text-start"></td>
                                        <td class="text-end"><strong><span t-esc="float(sum_base)" t-options='{"widget": "float", "precision": 2}'/></strong></td>
                                        <td class="text-end"><strong><span t-esc="float(sum_importe)" t-options='{"widget": "float", "precision": 2}'/></strong></td>
                                    </tr>
                                </tbody>
                            </table>

                            <t>
                                <t t-set="cfdi_vals" t-value="doc.get_qr_section_data()"/>
                                <div class="row" id="complement">
                                    <div t-if="cfdi_vals.get('sello')" class="barcode col-3">
                                        <img alt="Barcode" t-att-src="'/report/barcode/?barcode_type=QR&amp;value=%s&amp;width=180&amp;height=180' % quote_plus('https://verificacfdi.facturaelectronica.sat.gob.mx/default.aspx?' + keep_query(re=doc.rfc_emisor, rr=doc.company_id.vat, tt='%.*f' % (doc.currency_id.decimal_places, doc.total), id=doc.name) + '&amp;fe=%s' % quote_plus(cfdi_vals['sello'][-8:], 'utf-8', 'strict', '=/').replace('%2B', '+'))"/>
                                    </div>
                                    <div class="complement-details col-9">
                                        <div class="digital-stamp">
                                            <span>Sello digital del emisor</span>
                                        </div>
                                        <div class="digital-stamp-content">
                                            <span t-esc="cfdi_vals.get('sello')"/>
                                        </div>
                                        <div class="digital-stamp">
                                            <span>Sello digital de SAT</span>
                                        </div>
                                        <div class="digital-stamp-content">
                                            <span t-esc="cfdi_vals.get('sello_sat')"/>
                                        </div>
                                        <div class="digital-stamp">
                                            <span>Cadena original del complemento del certificado digital del SAT</span>
                                        </div>
                                        <div class="digital-stamp-content">
                                            <span class="nowrap" t-esc="cfdi_vals.get('cadena')"/>
                                        </div>
                                        <div class="digital-stamp">
                                            <span>Información Extra</span>
                                        </div>
                                        <div class="digital-stamp-content">
                                            <span>Certificado del emisor:</span> <span t-esc="cfdi_vals.get('certificate_number')"/>
                                            <span> | Certificado SAT:</span> <span t-esc="cfdi_vals.get('certificate_sat_number')"/>
                                            <span> | Lugar de expedición:</span> <span t-esc="cfdi_vals.get('expedition')"/>
                                            <span> | Régimen Fiscal:</span><span t-esc="cfdi_vals.get('fiscal_regime')"/>
                                            <span> | Fecha de Emisión:</span> <span t-esc="cfdi_vals.get('emission_date_str')"/>
                                            <span> | Fecha de Certificación:</span> <span t-esc="cfdi_vals.get('stamp_date')"/>
                                            <span> | Folio Fiscal:</span> <span t-esc="cfdi_vals.get('uuid')"/>
                                        </div>
                                        <div class="digital-stamp-content text-center">
                                            <strong>Este documento es una representación impresa de un CFDI</strong>
                                        </div>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </t>
                </t>
            </t>
        </template>
    </data>
</odoo>